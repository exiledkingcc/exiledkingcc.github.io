---
date:     2017-04-17
title:    å­—ç¬¦é›†ä¸ç¼–ç è¿™ä¹ˆæ··ä¹±æ€ä¹ˆæƒ³éƒ½æ˜¯å†å²çš„é”™
summary:  å­—ç¬¦é›†ä¸ç¼–ç çš„è‹¥å¹²å†å²é—®é¢˜
tags: ["charset"]
categories: ["coding"]
---

é¦–å…ˆï¼Œçœ‹åˆ°ä¹‹å‰çš„ä¸€ç¯‡æ˜¯åœ¨2016-10-22æ—¶å†™çš„ï¼Œçœ‹æ¥æ²»ç–—æ‡’ç™Œæ˜¯æœæ–­å¤±è´¥äº†ã€‚

å†™è¿™ä¸€ç¯‡ä¸»è¦æ˜¯æ¥è®²ä¸€è®²å­—ç¬¦é›†ä¸ç¼–ç çš„é—®é¢˜ï¼Œå› ä¸ºæˆ‘å‘ç°å¥½å¤šäººæä¸æ¸…æ¥šè¿™ä¸ªé—®é¢˜ã€‚ä¸è¿‡è¿™ä¹Ÿéš¾å…ï¼Œæ¯•ç«Ÿè¿™é‡Œé¢å¤ªå¤šå†å²é—®é¢˜äº†ã€‚
æ‰€ä»¥è¿™ç¯‡ä»å†å²çš„è¿›ç¨‹æ¥è®²è¿™ä¸ªé—®é¢˜ï¼Œå¸Œæœ›èƒ½å¤Ÿè®²æ¸…æ¥šã€‚

ç°åœ¨çš„è®¡ç®—æœºéƒ½æ˜¯32bitæˆ–è€…64bitçš„ï¼Œä¸€å­—èŠ‚æ˜¯8bitã€‚æœ‰äº›ç”¨äºåµŒå…¥å¼çš„èŠ¯ç‰‡å¯èƒ½æ˜¯8bitæˆ–è€…16bitçš„ã€‚
ç„¶è€Œåœ¨20ä¸–çºª70å¹´ä»£ï¼ˆ1970ï¼‰ä¹‹å‰ï¼Œè®¡ç®—æœºæ˜¯å„ç§bitéƒ½æœ‰çš„ã€‚ä¿„ç½—æ–¯è¿˜æè¿‡ä¸‰è¿›åˆ¶çš„è®¡ç®—æœºã€‚
åæ¥ä¸»è¦å°±æ˜¯ä¸€å­—èŠ‚8bitçš„ã€‚

é‚£ä¸ªæ—¶å€™çš„ç¼–ç æˆ‘ä¹Ÿä¸çŸ¥é“æ˜¯ä»€ä¹ˆæ ·çš„ï¼Œæ‰¾äº†ä¸€äº›èµ„æ–™ï¼Œçœ‹åˆ°äº†å‡ ç§äº’ç›¸éƒ½ä¸ä¸€æ ·çš„ã€‚è¿™ä¸ªæ—¶å€™å¤§æ¦‚æ˜¯éå¸¸æ··ä¹±çš„å§ã€‚

---

ç„¶åASCIIç è¯ç”Ÿäº†ï¼ŒASCIIåœ¨1960å¹´10æœˆå¼€å§‹æå‡ºï¼Œ1963å¹´å¼€å§‹å‘å¸ƒå‡ºç‰ˆï¼Œ1967å¹´ä¸»ç‰ˆæœ¬ï¼Œ1986å¹´æœ€åä¸€æ¬¡ä¿®è®¢ã€‚
ASCIIå®šä¹‰äº†æ€»å…±128ä¸ªå­—ç¬¦ï¼Œå…¶ä¸­33ä¸ªä¸å¯è§çš„æ§åˆ¶å­—ç¬¦ï¼Œ0-9é˜¿æ‹‰ä¼¯æ•°å­—ï¼Œå¤§å°å†™çš„26è‹±æ–‡å­—æ¯ï¼Œä»¥åŠä¸€äº›ç¬¦å·ã€‚

```
Dec Hex    Dec Hex    Dec Hex  Dec Hex  Dec Hex  Dec Hex   Dec Hex   Dec Hex
  0 00 NUL  16 10 DLE  32 20    48 30 0  64 40 @  80 50 P   96 60 `  112 70 p
  1 01 SOH  17 11 DC1  33 21 !  49 31 1  65 41 A  81 51 Q   97 61 a  113 71 q
  2 02 STX  18 12 DC2  34 22 "  50 32 2  66 42 B  82 52 R   98 62 b  114 72 r
  3 03 ETX  19 13 DC3  35 23 #  51 33 3  67 43 C  83 53 S   99 63 c  115 73 s
  4 04 EOT  20 14 DC4  36 24 $  52 34 4  68 44 D  84 54 T  100 64 d  116 74 t
  5 05 ENQ  21 15 NAK  37 25 %  53 35 5  69 45 E  85 55 U  101 65 e  117 75 u
  6 06 ACK  22 16 SYN  38 26 &  54 36 6  70 46 F  86 56 V  102 66 f  118 76 v
  7 07 BEL  23 17 ETB  39 27 '  55 37 7  71 47 G  87 57 W  103 67 g  119 77 w
  8 08 BS   24 18 CAN  40 28 (  56 38 8  72 48 H  88 58 X  104 68 h  120 78 x
  9 09 HT   25 19 EM   41 29 )  57 39 9  73 49 I  89 59 Y  105 69 i  121 79 y
 10 0A LF   26 1A SUB  42 2A *  58 3A :  74 4A J  90 5A Z  106 6A j  122 7A z
 11 0B VT   27 1B ESC  43 2B +  59 3B ;  75 4B K  91 5B [  107 6B k  123 7B {
 12 0C FF   28 1C FS   44 2C ,  60 3C <  76 4C L  92 5C \  108 6C l  124 7C |
 13 0D CR   29 1D GS   45 2D -  61 3D =  77 4D M  93 5D ]  109 6D m  125 7D }
 14 0E SO   30 1E RS   46 2E .  62 3E >  78 4E N  94 5E ^  110 6E n  126 7E ~
 15 0F SI   31 1F US   47 2F /  63 3F ?  79 4F O  95 5F _  111 6F o  127 7F DEL
```

åœ¨è¿™æ®µæ—¶æœŸè¿˜æœ‰å¾ˆå¤šå…¶ä»–çš„ç¼–ç ï¼Œæ¯”å¦‚IBMçš„[EBCDIC](https://en.wikipedia.org/wiki/EBCDIC)ã€‚
è¿™äº›éƒ½æ˜¯ç”¨æ¥ç¼–ç è‹±è¯­çš„ï¼Œè€Œä¸”äº’ç›¸å¹¶ä¸å…¼å®¹ã€‚æ¯”å¦‚EBCDICç¼–ç ä¸­æ²¡æœ‰`{`ã€`}`ç­‰å­—ç¬¦ã€‚ç†Ÿæ‚‰C/C++çš„
åº”è¯¥éƒ½çŸ¥é“ï¼Œå¯ä»¥ç”¨`??<`è¡¨ç¤º`{`ï¼Œç”¨`??>`è¡¨ç¤º`}`ï¼Œå°±æ˜¯ä¸ºäº†å…¼å®¹è¿™ç§ç¼–ç ã€‚ç”±æ­¤è¿˜å¸¦æ¥äº†ä¸€ä¸ª
å¯èƒ½ä»¤äººå›°æƒ‘çš„æ½œåœ¨çš„bugï¼š

```c++
// is this right???/
x += 2;
```

C/C++ä¼šå°†`??/`è§£é‡Šæˆ`\`ï¼Œè¿™æ ·ä¸‹é¢çš„`x += 2;`å°±æˆäº†æ³¨é‡Šçš„ä¸€éƒ¨åˆ†ã€‚

---

è¨€å½’æ­£ä¼ ã€‚è‹±è¯­çš„ç¼–ç æ–¹æ¡ˆæˆç†Ÿåï¼Œè®¡ç®—æœºçš„ä½¿ç”¨ä¹Ÿä»ç¾å›½æ‰©å±•åˆ°äº†å…¨ä¸–ç•Œï¼Œé¦–å…ˆå°±æ˜¯æ¬§æ´²ã€‚æ¬§æ´²æœ‰å¾ˆå¤š
ä¸åŒçš„è¯­è¨€ï¼Œæ¯”å¦‚æ³•è¯­ã€å¾·è¯­ã€æ„å¤§åˆ©è¯­ç­‰ï¼Œè¿™äº›è¯­è¨€è™½è¯´ä¸è‹±è¯­éƒ½æ˜¯ä»æ‹‰ä¸è¯­å˜åŒ–è€Œæ¥çš„ï¼Œååˆ†ç›¸ä¼¼ï¼Œ
ä½¿ç”¨çš„å­—ç¬¦å¾ˆå¤šéƒ½æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯ä¹Ÿæœ‰éƒ¨åˆ†å­—ç¬¦æ˜¯ä¸åŒçš„ï¼Œéœ€è¦å¦å¤–çš„è¡¨ç¤ºã€‚å†µä¸”è¿˜æœ‰åƒå¸Œè…Šè¯­è¿™æ ·ä¸
è‹±è¯­å·®åˆ«å¾ˆå¤§çš„è¯­è¨€ã€‚è¿™æ ·ASCIIç æ˜¾ç„¶æ˜¯æ²¡æœ‰åŠæ³•å¤„ç†çš„ã€‚æ€ä¹ˆåŠå‘¢ï¼Ÿ

**æ–¹æ³•å°±æ˜¯æ‰©å±•ASCIIç **ã€‚

ASCIIç å­—ç¬¦æœ‰128ä¸ªï¼Œä¸€å…±ç”¨äº†ä¸€ä¸ªå­—èŠ‚8bitä¸­çš„7bitï¼Œè¿˜æœ‰ä¸€ä½æ²¡ç”¨ã€‚æ‰©å±•ASCIIå°±æ˜¯ä»è¿™å‰©ä½™çš„1bitå…¥æ‰‹ï¼Œ
è¿™ä¸€ä½å°±å¤šäº†127ä¸ªå­—ç¬¦ï¼Œå¯¹äºä½¿ç”¨å­—æ¯ç¬¦å·çš„è¯­è¨€æ¥è¯´å·²ç»å¤Ÿç”¨äº†ã€‚ç„¶è€Œå¯¹äºä¸€ç§ï¼Œæˆ–è€…ç›¸ä¼¼åº¦å¾ˆå¤šçš„å‡ ç§
è¯­è¨€128ä¸ªå­—ç¬¦ä¹Ÿè®¸å¤Ÿç”¨ï¼Œä½†æ˜¯è¦æƒ³æŠŠè¿™äº›å…¨éƒ¨æ”¾ä¸€èµ·ï¼Œ128å°±æ˜¾å¾—å¾ˆå°‘äº†ã€‚äºæ˜¯å¯¹ä¸ASCIIçš„æ‰©å±•æœ‰å¾ˆå¤šï¼Œè¿™äº›
å…±åŒå½¢æˆäº†ä¸€ä¸ªæ ‡å‡†[ISO/IEC 8859](https://en.wikipedia.org/wiki/ISO/IEC_8859)ã€‚

`ISO/IEC 8859`æ˜¯ä¸€ä¸ª8bitçš„å­—ç¬¦ç¼–ç æ ‡å‡†ï¼Œä¸åŒäºASCIIçš„ä¸€å¼ è¡¨ï¼Œå®ƒç”±å¾ˆå¤šéƒ¨åˆ†ç»„æˆã€‚æ¯”å¦‚`ISO/IEC 8859-1`ï¼Œ
ä¹Ÿå°±æ˜¯`Latin-1`ï¼ŒåŒ…å«äº†å¾·è¯­ã€æ„å¤§åˆ©è¯­ã€æ‹‰ä¸è¯­ç­‰è¯­è¨€ã€‚æ¯”å¦‚`ISO/IEC 8859-7`ï¼Œä¹Ÿç§°ä¸º`Latin/Greek`ï¼ŒåŒ…å«äº†
å¸Œè…Šè¯­ã€‚

---

å¯ä»¥çœ‹åˆ°ï¼Œæ­¤æ—¶çš„ASCIIç æ‰©å±•æ–¹å¼éƒ½æ˜¯è€ƒè™‘å•å­—èŠ‚çš„ç¼–ç æ–¹å¼ã€‚æ˜¾ç„¶ä¸€ä¸ªå­—èŠ‚çš„ç¼–ç ç©ºé—´å¤ªå°ï¼Œå¯¹äºå­—æ¯è¯­è¨€æˆ–è®¸ç”¨
ä¸Šè¿°è›‹ç–¼çš„æ–¹å¼è¿˜å¯ä»¥å‹‰å¼ºä½¿ç”¨ï¼Œä½†æ˜¯å¯¹äºä¸œäºšçš„è¯­è¨€ï¼Œç‰¹åˆ«æ˜¯æ±‰è¯­ï¼Œå°±å®Œå…¨ä¸è¡Œäº†ã€‚è®¡ç®—æœºåˆ°äº†äºšæ´²ï¼Œåˆ°äº†ä¸­å›½åï¼Œ
å½“åœ°çš„å­—ç¬¦æ€ä¹ˆè¡¨ç¤ºå‘¢ï¼Ÿè¿˜æ˜¯**æ‰©å±•ASCIIç **ã€‚æ±‰å­—è¿™ä¹ˆå¤šï¼Œæ˜¾ç„¶ä¸€ä¸ªå­—èŠ‚8bitæ˜¯è£…ä¸ä¸‹çš„ï¼Œæ²¡åŠæ³•åªèƒ½ç”¨ä¸¤ä¸ªå­—èŠ‚äº†
ï¼ˆå½“ç„¶ä¸¤ä¸ªä¹Ÿæ˜¯ä¸å¤Ÿçš„ï¼Œä¸è¿‡è¿™æ˜¯åè¯äº†ï¼‰ã€‚è¿™å°±æ˜¯[GB-2312](https://zh.wikipedia.org/wiki/GB_2312)äº†ã€‚

GB-2312ä¸­çš„GBæ˜¯å›½å®¶æ ‡å‡†ï¼ˆ`Guojia Biaozhun`ï¼‰çš„æ„æ€ã€‚GB-2312ä¸ºäº†èƒ½è¡¨ç¤ºæ•°é‡å·¨å¤§çš„æ±‰å­—ï¼Œä½¿ç”¨äº†ä¸¤ä¸ªå­—èŠ‚ï¼Œ
åˆä¸ºäº†å…¼å®¹ASCIIï¼Œå®é™…ä¸Šæ˜¯ä¸€ç§**å˜é•¿ç¼–ç **ã€‚ç¬¬ä¸€ä¸ªå­—èŠ‚çš„èŒƒå›´åœ¨0x00-0x7fæ—¶ï¼Œå°±å’ŒASCIIä¸€æ ·ï¼Œåªå ä¸€ä½ï¼Œ
å…¶å®ƒçš„æƒ…å†µå ä¸¤ä½ã€‚ä¸è¿‡è¦æ³¨æ„ï¼Œå¹¶ä¸èƒ½å–0x00-0xffæ‰€æœ‰çš„å€¼ï¼Œæœ‰äº›å€¼æ˜¯éæ³•çš„ã€‚GB 2312æ ‡å‡†å…±æ”¶å½•6763ä¸ªæ±‰å­—ï¼Œ
å…¶ä¸­ä¸€çº§æ±‰å­—3755ä¸ªï¼ŒäºŒçº§æ±‰å­—3008ä¸ªï¼›åŒæ—¶æ”¶å½•äº†åŒ…æ‹¬æ‹‰ä¸å­—æ¯ã€å¸Œè…Šå­—æ¯ç­‰åœ¨å†…çš„682ä¸ªå­—ç¬¦ï¼Œè¦†ç›–äº†å¤§éƒ¨åˆ†å¸¸ç”¨æ±‰å­—ï¼Œ
ç„¶è€Œè¿˜æ˜¯æœ‰ä¸€äº›æ²¡æœ‰æ”¶å½•çš„ï¼Œåæ¥çš„GBKæ˜¯å¯¹GB-2312çš„ä¸€ç§è¡¥å……ï¼Œå¢åŠ äº†å¾ˆå¤šå†…å®¹ï¼Œå¹¶ä¸”å…¼å®¹GB-2312ã€‚æœ‰æ„æ€çš„æ˜¯ï¼š
GBKå¹¶ä¸æ˜¯å›½å®¶æ ‡å‡†ï¼Œåªæ˜¯â€œæŠ€æœ¯è§„èŒƒæŒ‡å¯¼æ€§æ–‡ä»¶â€ï¼Œç„¶è€Œç°å®ä¸­çš„å®ç°å¤§å¤šæ˜¯éƒ½æ˜¯GBKè€Œä¸æ˜¯GB-2312ã€‚

å°æ¹¾ä½¿ç”¨çš„Big5ç¼–ç ä¸æ—¥æœ¬çš„Shift_JISç¼–ç ï¼Œä¸GBç³»åˆ—ç¼–ç ç±»ä¼¼ï¼Œåªæ˜¯æ˜ å°„çš„å­—ç¬¦ä¸å…·ä½“çš„ç¼–ç æ–¹å¼ä¸ä¸€æ ·ã€‚

---

æŒ‰ç…§ä»¥ä¸Šçš„æ–¹å¼ï¼Œä¸–ç•Œä¸Šå¸¸ç”¨çš„è¯­è¨€æ–‡å­—éƒ½å·²ç»åœ¨è®¡ç®—æœºä¸­ç¼–ç äº†ï¼ŒæŠ•å…¥ä½¿ç”¨äº†ã€‚è¿™äº›éƒ½æ˜¯`language-specific encodings`ã€‚
ç„¶è€Œï¼Œå…¨çƒåŒ–çš„æ½®æµè¦æ±‚èƒ½å¤Ÿæ–¹ä¾¿åœ°ä½¿ç”¨å¤šç§è¯­è¨€æ–‡å­—ï¼Œå¦‚æœä½¿ç”¨ä¸Šè¿°çš„è¿™ä¹ˆå¤šç¼–ç å»å®ç°è¿™ä¸ªç›®æ ‡å°±å¾ˆè›‹ç–¼äº†ã€‚é¦–å…ˆæ˜¯ç³»ç»Ÿçš„æ”¯æŒ
é—®é¢˜ï¼Œè¦ä¸€ä¸ªç³»ç»ŸåŒæ—¶æ”¯æŒè¿™ä¹ˆå¤šçš„ç¼–ç æ˜¯å¾ˆå¤§çš„å·¥ä½œé‡ã€‚å…¶æ¬¡ï¼Œå³ä¾¿ä½ çš„ç³»ç»Ÿæ”¯æŒï¼Œä½ å¿…é¡»è¦æ ‡è®°æ–‡æœ¬å®ƒæ­£ç¡®çš„ç¼–ç æ˜¯ä»€ä¹ˆï¼Œ
ç„¶åå»è§£ç ï¼Œä¸ç„¶å°±ä¹±ç äº†ã€‚å¹¶ä¸”ä¸åŒçš„ç¼–ç ä¸èƒ½æ”¾åœ¨åŒä¸€ä»½æ–‡æœ¬ä¸­ã€‚

è®¤è¯†åˆ°è¿™ä¸ªé—®é¢˜åï¼Œä¸€äº›æœ‰å¿—ä¹‹å£«å°±å¼€å§‹ç€æ‰‹è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå…¶æ€è·¯å°±æ˜¯æŠŠä¸–ç•Œä¸Šæ‰€æœ‰æ–‡å­—ã€ç¬¦å·æ”¾åˆ°ä¸€ä¸ªç¼–ç æ–¹æ¡ˆä¸­ç»Ÿä¸€èµ·æ¥ã€‚
è¿™æ ·ä¸Šè¾¹çš„é—®é¢˜å°±è¿åˆƒè€Œè§£äº†ã€‚è¿™é‡Œä¹Ÿæœ‰äº›æ„æ€ï¼Œå› ä¸ºæœ‰ä¸¤æ‹¨äººåŒæ—¶æè¿™ä¸ªä¸œè¥¿.ä¸€ä¸ªæ˜¯å›½é™…æ ‡å‡†åŒ–ç»„ç»‡ISOçš„`ISO/IEC JTC 1/SC 2`ï¼Œ
ä»–ä»¬è¿‡äº†ä¸€ä¸ª`ISO/IEC 10646`æ ‡å‡†ï¼Œä¹Ÿå°±æ˜¯[UCS](https://en.wikipedia.org/wiki/Universal_Coded_Character_Set)ã€‚
å¦ä¸€ä¸ªæ˜¯ä¸€äº›è®¡ç®—æœºç›¸å…³å‚å•†çš„Unicodeè”ç›Ÿï¼ˆ`The Unicode Consortium`ï¼‰ï¼Œä»–ä»¬æäº†ä¸€ä¸ª[Unicode](https://en.wikipedia.org/wiki/Unicode)æ ‡å‡†ã€‚

æ˜¾ç„¶ï¼Œä¸ºäº†ç»Ÿä¸€å„ç§è¯­è¨€çš„ç¼–ç ï¼Œæœ€ååè€Œæå‡ºä¸¤ä¸ªæ ‡å‡†ï¼Œè¿™å°±ä¼šéå¸¸å°´å°¬äº†ã€‚`ISO/IEC`ä¸`Unicode`ä»–ä»¬ä¸¤æ‹¨äººä¹Ÿè®¤è¯†åˆ°è¿™ä¸€ç‚¹ï¼Œäºæ˜¯
ç»Ÿä¸€äº†ä¸¤ä¸ªæ ‡å‡†ã€‚ç°åœ¨ï¼Œè¿™ä¸¤ç§æ ‡å‡†éƒ½æ˜¯å­˜åœ¨çš„ï¼Œå¹¶ä¸”éƒ½åœ¨ä¿®è®¢ä¸æ›´æ–°ï¼Œåªä¸è¿‡éƒ½æ˜¯ä¸€æ ·çš„ã€‚

çœ‹èµ·æ¥ï¼Œå­—ç¬¦ç¼–ç çš„é—®é¢˜å¾—åˆ°äº†è§£å†³ï¼Œå®é™…ä¸Šå¹¶ä¸ç„¶ï¼Œé¡¶å¤šç®—æ˜¯è§£å†³äº†50%ã€‚

---

è¿™é‡Œè¦å…ˆå°†å­—ç¬¦ç¼–ç è¿™ä¸ªæ¦‚å¿µæ‹†å¼€æ¥çœ‹ï¼Œåˆ†åˆ«æ˜¯å­—ç¬¦ä¸ç¼–ç ã€‚

é¦–å…ˆåœ¨è®¡ç®—æœºä¸­åªæœ‰0å’Œ1ï¼Œæ¯ä¸ªæ˜¯ä¸€ä¸ªbitã€‚ç”±8ä¸ªbitï¼ˆ0æˆ–1ï¼‰æ„æˆäº†ä¸€ä¸ªå­—èŠ‚ï¼ˆbyteï¼‰ã€‚ç„¶åä»¥nä¸ªbyteä¸ºå•å…ƒï¼Œæœ‰äº†ä¸åŒä½çš„æ•´æ•°ï¼Œ
æ¯”å¦‚32ä½æ•´æ•°ï¼Œ64ä½æ•´æ•°ã€‚å…·ä½“çš„çœ‹ï¼Œè®¡ç®—æœºä¸­éƒ½æ˜¯0å’Œ1æ„æˆäºŒè¿›åˆ¶ï¼ŒæŠ½è±¡çœ‹ï¼Œå°±æ˜¯ä¸€ç³»åˆ—æ•´æ•°ã€‚
å­—ç¬¦ç¼–ç å°±æ˜¯å­—ç¬¦çš„äºŒè¿›åˆ¶è¡¨ç¤ºã€‚è¿™é‡Œå°±å­˜åœ¨ä¸¤ä¸ªé—®é¢˜ï¼Œä¸€æ˜¯è¿™ä¸ªå­—ç¬¦æ˜ å°„åˆ°ä»€ä¹ˆæ•´æ•°ï¼ŒäºŒæ˜¯è¿™ä¸ªæ•´æ•°è¦æ€ä¹ˆç”¨äºŒè¿›åˆ¶è¡¨ç¤ºã€‚
è¿™å°±æ˜¯å­—ç¬¦é›†ä¸ç¼–ç æ–¹å¼çš„æ¦‚å¿µã€‚åœ¨Unicodeä¹‹å‰ï¼Œè¿™ä¸¤ä¸ªæ¦‚å¿µæ²¡æœ‰ä¸¥æ ¼åˆ†å¼€ï¼Œæ¯ä¸€ç§`language-specific encodings`éƒ½æ˜¯
å­—ç¬¦é›†ä¸ç¼–ç æ–¹å¼ç»‘åœ¨ä¸€èµ·ã€‚è€ŒUnicodeåˆ™æ˜¯ä¸€ç§å­—ç¬¦é›†å¯¹åº”å¤šç§ç¼–ç æ–¹å¼ã€‚

Unicodeæœ€å¼€å§‹çš„æ—¶å€™ï¼Œæ˜¯ä¸€ç§16bitçš„ç¼–ç æ–¹æ¡ˆã€‚è€ŒISO/IECä¸€å¼€å§‹å°±æ˜¯è®¾è®¡äº†å­—ç¬¦é›†ï¼Œåªä¸è¿‡å®é™…ä¸­åªç”¨åˆ°äº†å‰é¢çš„65536ä¸ªç¼–ç ï¼Œ
è¿™ç§ç¼–ç æ–¹æ¡ˆæˆä¸ºUCS-2ï¼Œä¹Ÿæ˜¯ç”¨ä¸¤ä¸ªå­—èŠ‚16bitæ¥ç¼–ç ï¼Œåæ¥å‘ç°16bitçš„ç¼–ç ç©ºé—´ä¸å¤Ÿäº†ï¼Œæå‡ºäº†UCS-4çš„32bitç¼–ç æ–¹æ¡ˆã€‚
è€ŒUnicodeä¸€å¼€å§‹æ˜¯å›ºå®šçš„16bitçš„ç¼–ç ï¼Œåæ¥ä¸¤è€…åˆå¹¶äº†ä¹‹åï¼ŒUnicodeçš„æ¦‚å¿µå‘ç”Ÿå˜åŒ–äº†ï¼Œæˆä¸ºäº†ä¸€ç§å­—ç¬¦é›†ï¼Œ
è€ŒåŸå§‹çš„Unicodeçš„ç¼–ç æ–¹æ¡ˆå°±æ˜¯æ²¡æœ‰ä»£ç†å¯¹ï¼ˆ`surrogate pairs`ï¼‰çš„UTF-16ã€‚ç°åœ¨çš„UTF-16ä½¿ç”¨`surrogate pairs`ï¼Œå˜æˆäº†å˜é•¿ç¼–ç ï¼Œ
å¯ä»¥è¡¨ç¤ºæ•´ä¸ªUnicodeå­—ç¬¦é›†ã€‚ä½†æ˜¯ç”±äºè¿™äº›å†å²åŸå› ï¼ŒUnicodeçš„æ„ä¹‰åœ¨ä¸åŒçš„è¯­å¢ƒä¸‹æ„æ€ä¸åŒã€‚
ç°åœ¨è°ˆåˆ°Unicodeä¸€èˆ¬å°±æ˜¯æŒ‡Unicodeå­—ç¬¦é›†ï¼Œè°ˆåˆ°å…·ä½“çš„ç¼–ç æ–¹å¼ï¼Œä¼šä½¿ç”¨UTF-8ã€UTF-16ç­‰ï¼Œ
ä½†æ˜¯æœ‰ä¸€äº›åœ°æ–¹åœ¨ç¼–ç çš„æ—¶å€™ä¹Ÿæ˜¯ç”¨Unicodeè¿™ä¸ªè¯ï¼Œä¸€èˆ¬æŒ‡çš„æ˜¯UTF-16ã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨æ—¶æœ€å¥½ç»Ÿä¸€æ¦‚å¿µï¼ŒUnicodeå°±è¡¨ç¤ºUnicodeå­—ç¬¦é›†ï¼Œä¸è¡¨ç¤ºä»»ä½•ç¼–ç æ–¹æ¡ˆï¼Œä½¿ç”¨UTFç³»åˆ—æ¥è¡¨ç¤ºå„ç§å…·ä½“ç¼–ç æ–¹æ¡ˆï¼Œ
ä¸è¦å†ä½¿ç”¨å·²ç»è¿‡æ—¶çš„æ¦‚å¿µäº†ã€‚

---

Unicodeå°†ä¸–ç•Œå„åœ°çš„å­—ç¬¦ï¼Œç¬¦å·è¿›è¡Œäº†ç»Ÿä¸€çš„ç¼–ç ï¼Œç”¨ä¸€ä¸ªæ•´æ•°è¡¨ç¤ºï¼Œç§°ä¸ºä¸€ä¸ªç ç‚¹ï¼ˆ`code point`ï¼‰ã€‚
ç›®å‰Unicodeä¸­`code point`çš„èŒƒå›´æ˜¯0-0x10ffffï¼Œæ€»å…±è¢«åˆ†ä¸º17ä¸ªéƒ¨åˆ†ï¼Œç§°ä¸ºå­—ç¬¦æ˜ å°„å¹³é¢ï¼ˆ`plane`ï¼‰ï¼Œ
æ¯ä¸€å¹³é¢æœ‰65536ï¼ˆ2<sup>16</sup>ï¼‰ä¸ª`code point`ã€‚
å…¶ä¸­ç¬¬0å·planeè¢«ç§°ä¸ºåŸºæœ¬å¤šæ–‡ç§å¹³é¢ï¼ˆ`Basic Multilingual Plane`ï¼Œ`BMP`ï¼‰ï¼ŒåŒ…å«äº†ä¸–ç•Œå„åœ°çš„å¸¸ç”¨æ–‡å­—ã€ç¬¦å·ã€‚
å…¶ä½™çš„planeç§°ä¸ºè¡¥å……å¹³é¢ï¼Œæ˜¯å¯¹BMPçš„è¡¥å……ã€‚æ¯”å¦‚å¸¸è§çš„æ±‰å­—ç¬¦å·å°±åœ¨BMPä¸­ï¼Œä¸å¸¸ç”¨çš„åœ¨å…¶å®ƒå¹³é¢ä¸­ã€‚
é™¤äº†æ–‡å­—ã€æ•°å­—å­—ç¬¦ç­‰ï¼ŒUnicodeè¿˜ç¼–ç äº†å¾ˆå¤šå…¶å®ƒçš„ç¬¦å·ï¼Œæ¯”å¦‚emojiä¸­çš„ğŸ˜‚çš„`code point`æ˜¯U+1F602ã€‚è¿˜æœ‰`surrogate pairs`ï¼Œ
ä¸ç”¨æ¥ç¼–ç ä»»ä½•ç¬¦å·ï¼Œè€Œæ˜¯ä½œä¸ºç»„åˆæ¥ä½¿ç”¨ã€‚

---

ç„¶è€Œæœ‰äº†Unicodeï¼Œè¿˜åªæ˜¯è§£å†³äº†å­—ç¬¦é›†çš„é—®é¢˜ã€‚è¿˜æœ‰ç¼–ç è¿™ä¸ªå‘ã€‚Unicodeä¸å‰é¢æåˆ°çš„GBKä¹‹ç±»çš„ä¸åŒï¼Œå®ƒä¸€ä¸ªå­—ç¬¦é›†æœ‰å¤šç§ç¼–ç æ–¹æ¡ˆã€‚
ç°åœ¨å¹¿æ³›ä½¿ç”¨çš„ä¸»è¦æ˜¯UTF-8ã€UTF-16å’ŒUTF-32è¿™ä¸‰ç§ã€‚

æœ€å¼€å§‹æ˜¯[UTF-16](https://en.wikipedia.org/wiki/UTF-16)ï¼Œå›ºå®šçš„16bitç¼–ç ï¼Œ
åæ¥åŠ ä¸Šäº†`surrogate pairs`ï¼Œæˆä¸ºå˜é•¿ç¼–ç ï¼Œå®ƒä»¥16bitä¸ºä¸€ä¸ªå•å…ƒ ã€‚å…·ä½“çš„ç¼–ç æ–¹æ¡ˆå¦‚ä¸‹ï¼š

| code ponit range | first 16bit unit | second 16bit unit  |
| ---------------- | ---------------- | ------------------ |
| U+0000 - U+D7FF  | 0x0000 - 0xD7FF  | |
| U+D800 - U+DBFF  | | |
| U+DC00 - U+DFFF  | | |
| U+E000 - U+FFFF  | 0xE000 - 0xFFFF  | |
| U+10000 - U+10FFFF | 0xD800 - 0xDBFF | 0xDC00 - 0xDFFF |

* `U+0000-U+D7FF`ä¸`U+E000-U+FFFF`è¿™ä¸ªèŒƒå›´å†…çš„code pointsï¼Œç”¨ä¸€ä¸ª16bitçš„å•ä½è¡¨ç¤ºï¼Œå€¼ä¸code pointç›¸åŒï¼›
* `U+D800-U+DFFF`æ˜¯`surrogate pairs`ï¼›
* `U+10000-U+10FFFF`è¿™ä¸ªèŒƒå›´å†…çš„ç”¨ä¸¤ä¸ª16bitå•å…ƒè¡¨ç¤ºï¼Œä¹Ÿå°±æ˜¯ `surrogate pairs`ï¼Œè®¡ç®—æ–¹å¼å¦‚ä¸‹ï¼š
  - å…ˆå‡å»0x10000ï¼Œå‰©ä¸‹çš„ä¸€å…±æ˜¯20bitï¼Œåˆ†æˆé«˜ä½å„10bit
  - é«˜ä½10bitåŠ ä¸Š0xD800ï¼Œæˆä¸ºfirst 16bit unitï¼Œä¹Ÿå«åšhigh surrogate
  - ä½ä½10bitåŠ ä¸Š0xDC00ï¼Œæˆä¸ºsecond 16bit unitï¼Œä¹Ÿå«åšlow surrogate
  - è®¡ç®—ä»£ç å¦‚ä¸‹ï¼š

```c++
inline std::uint32_t surrogate_combine(std::uint32_t high, std::uint32_t low) {
  return 0x10000 + ((high & 0x3ff) << 10 | (low & 0x3ff));
}

inline void surrogate_split(std::uint32_t u, std::uint32_t& high, std::uint32_t& low) {
  u -= 0x10000;
  low = (u & 0x3ff) | 0xdc00;
  high = ((u >> 10) & 0x3ff) | 0xd800;
}
```

[UTF-32](https://en.wikipedia.org/wiki/UTF-32)å°±æ˜¯32bitä¸€ä¸ªå•å…ƒï¼Œç›®å‰Unicodeçš„æ‰€æœ‰`code point`éƒ½ä¸è¶…è¿‡2<sup>32</sup>ï¼Œ
æ‰€ä»¥ä¸€ä¸ª`code point`å¯ä»¥åªä½¿ç”¨ä¸€ä¸ª32bitå•å…ƒè¡¨ç¤ºï¼Œå°±æ˜¯ä¸€ä¸ªuint32çš„å€¼ã€‚

[UTF-8](https://en.wikipedia.org/wiki/UTF-8)ä»¥8bitï¼Œä¹Ÿå°±æ˜¯1byteä¸ºä¸€ä¸ªå•å…ƒã€‚æ˜¾ç„¶UTF-8ä¹Ÿæ˜¯å˜é•¿çš„ã€‚ç¼–ç æ–¹æ¡ˆå¦‚ä¸‹ï¼š

| code point range | Byte 1 | Byte 2 | Byte 3 | Byte 4 |
| ---------------- | ------ | ------ | ------ | ------ |
| U+0000 - U+007F  | 0b0xxxxxxx |  |  |  |
| U+0080 - U+07FF  | 0b110xxxxx | 0b10xxxxxx |  |  |
| U+0800 - U+FFFF  | 0b1110xxxx | 0b10xxxxxx | 0b10xxxxxx	|
| U+10000 - U+10FFFF | 0b11110xxx | 0b10xxxxxx | 0b10xxxxxx | 0b10xxxxxx |

* UTF-8å®Œå…¨å…¼å®¹ASCIIï¼ŒASCIIæ–‡æœ¬åŒæ—¶ä¹Ÿæ˜¯åˆæ³•æœ‰æ•ˆçš„UTF-8æ–‡æœ¬
* ä»¥ç¬¬ä¸€ä¸ªå­—èŠ‚çš„å¤§å°å¯ä»¥åˆ¤æ–­æœ‰å‡ ä¸ªå­—èŠ‚
* åé¢å­—èŠ‚çš„æœ€é«˜ä¸¤ä½éƒ½æ˜¯10ï¼Œç”¨äºåŒæ­¥çº é”™

UTF-8æ˜¯ç›®å‰Webä»¥åŠå…¶å®ƒç½‘ç»œä¼ è¾“ä½¿ç”¨æœ€å¤šçš„ç¼–ç ã€‚

![Utf8webgrowth](/img/Utf8webgrowth.svg)

---

UTF-8ä½¿ç”¨å¦‚æ­¤ä¹‹å¤šï¼Œä¸»è¦åŸå› ä¸€æ˜¯Unicodeè¢«å¹¿æ³›æ¥å—ï¼ŒäºŒæ˜¯ç›¸å¯¹äºUTF-16ï¼ŒUTF3-2ï¼ŒUTF-8æ²¡æœ‰å­—èŠ‚åºé—®é¢˜ã€‚

å­—èŠ‚åºï¼ˆ[Endianness](https://en.wikipedia.org/wiki/Endianness)ï¼‰å°±æ˜¯å­—èŠ‚åœ¨å†…å­˜ä¸­ä»¥æ€æ ·çš„é¡ºåºå­˜æ”¾ã€‚
å†…å­˜çš„åŸºæœ¬å•å…ƒæ˜¯1byteï¼ˆ8bitï¼‰ï¼Œ16bitå°±æ˜¯2byteï¼Œ32bitå°±æ˜¯4byteã€‚ä¸€ä¸ª16bitçš„æ•°å­—ï¼Œæ¯”å¦‚0x12345678ï¼Œå°±æ˜¯0x1234ï¼ˆé«˜ä½ï¼‰ä¸0x5678ï¼ˆä½ä½ï¼‰ä¸¤ä¸ªå­—èŠ‚ã€‚
è¿™ä¸¤ä¸ªå­—èŠ‚åœ¨å†…å­˜ä¸­è°æ”¾åœ¨å‰é¢ï¼ˆå†…å­˜ä½ä½ï¼‰è°æ”¾åœ¨åé¢ï¼ˆå†…å­˜é«˜ä½ï¼‰ï¼Œè¿™æ˜¯ä¸€ä¸ªé—®é¢˜ã€‚å­—èŠ‚åºè§„å®šäº†è¿™ä¸ªé¡ºåºã€‚
å­—èŠ‚åºæœ‰ä¸¤ç§ï¼Œæ•°å­—é«˜ä½æ”¾åœ¨å†…å­˜é«˜ä½çš„æ˜¯â€œå°ç«¯â€å­—èŠ‚åºï¼Œåè¿‡æ¥ï¼Œæ•°å­—é«˜ä½æ”¾åœ¨å†…å­˜ä½ä½çš„æ˜¯â€œå¤§ç«¯â€å­—èŠ‚åºã€‚
è¿™â€œå¤§å°ç«¯â€çš„åå­—æ¥æºä¹Ÿæœ‰äº›æ„æ€ï¼Œä¸è¿‡è¿™é‡Œå°±ä¸è®²äº†ã€‚

UTF-8çš„åŸºæœ¬å•å…ƒå°±æ˜¯1byteï¼Œä¸å­˜åœ¨å­—èŠ‚åºé—®é¢˜ã€‚UTF-16ä¸UTF-32éƒ½æœ‰å­—èŠ‚åºé—®é¢˜ï¼Œè¿™ä¸¤ç§ç¼–ç å„è‡ªéƒ½æœ‰å°ç«¯ï¼ˆLEï¼‰ä¸å¤§ç«¯ï¼ˆBEï¼‰ä¸¤ç§ï¼Œä¸€å…±å››ç§ï¼š
UTF-16LEã€UTF-16BEã€UTF-16LEã€UTF-16BEã€‚

ä¸ºäº†åˆ†è¾¨ä¸€ä¸ªæ–‡æœ¬æ˜¯å¤§ç«¯çš„è¿˜æ˜¯å°ç«¯çš„ï¼ŒUnicodeè§„å®šå¯ä»¥åœ¨æœ€å‰é¢æ”¾ä¸€ä¸ªç‰¹å®šçš„æ ‡è®°ï¼Œ
è¿™å°±æ˜¯å­—èŠ‚åºæ ‡è®°ï¼ˆByte order markerï¼Œ [BOM](https://en.wikipedia.org/wiki/Byte_order_mark)ï¼‰ã€‚
Unicodeå®šä¹‰äº†ä¸€ä¸ª`code point`æ¥è¡¨ç¤ºå­—èŠ‚åºï¼Œå€¼ä¸ºU+FEFFã€‚
UTF-16æœ€å‰é¢ä¸¤ä¸ªå­—èŠ‚æ˜¯0xffã€0xfeæ—¶æ˜¯UTF-16LEï¼Œæ˜¯0xfeã€0xffæ—¶æ˜¯UTF-16BEã€‚
UTF-32æœ€å‰é¢å››ä¸ªå­—èŠ‚æ˜¯0xffã€0xfeã€0x00ã€0x00æ—¶æ˜¯UTF-32LEï¼Œæ˜¯0x00ã€0x00ã€0xfeã€0xffæ—¶æ˜¯UTF-32BEã€‚
UTF-8ä¸éœ€è¦BOMï¼Œä¸è¿‡ä¹Ÿå¯ä»¥æœ‰BOMï¼Œä¸‰ä¸ªå­—èŠ‚ï¼š0xefã€0xbbã€0xbfã€‚

---

å†è¯´ä¸€ä¸‹å„ç§ç¼–ç¨‹è¯­è¨€ä¸­çš„ç¼–ç æƒ…å†µã€‚

C/C++å¤ªè€äº†ï¼Œé‚£ä¸ªæ—¶å€™è¿˜ä¸æ€ä¹ˆå…³å¿ƒç¼–ç é—®é¢˜ï¼ŒC/C++ä¸­çš„charåŸºæœ¬ä¸Šå°±æ˜¯byteã€‚

* charæ˜¯byteï¼Œchar*å°±æ˜¯å­—èŠ‚æµï¼Œä¸å­—ç¬¦é›†ã€ç¼–ç éƒ½æ²¡ä¸ºå…³ç³»ï¼Œæºæ–‡ä»¶æ˜¯ä»€ä¹ˆç¼–ç ï¼Œå†…å®¹ä¸­å°±æ˜¯ä»€ä¹ˆæ ·çš„ã€‚
* C++ä¸­çš„`string`å°±æ˜¯å°è£…äº†çš„charæ•°ç»„ã€‚
* C/C++ä¸­çš„å®½å­—ç¬¦`wchar_t`æ˜¯ä¸ªå¾ˆå°´å°¬çš„ä¸œè¥¿ï¼Œæ ‡å‡†å°±æ˜¯è§„å®šå¯ä»¥å­˜å‚¨æ›´å¤§çš„å­—ç¬¦é›†ï¼Œè¿™ä¸ªæœ€å¤§çš„å­—ç¬¦é›†å°±æ˜¯localeä¸­çš„å­—ç¬¦é›†ï¼Œ
ä¹Ÿå°±æ˜¯è¯´ï¼Œ`wchar_t`å®é™…ä¸Šå¯ä»¥å’Œcharä¸€æ ·å¤§ã€‚å¦å¤–ï¼Œ`wchar_t`æ˜¯`compiler-specific`ï¼Œå®ƒåˆ°åº•æœ‰å¤šå°‘ä¸ªbitéƒ½æ˜¯ä¸ç¡®å®šçš„ã€‚
* C11/C++11å¢åŠ çš„`char16_t`å’Œ`char32_t`ï¼Œå°±æ˜¯16bitå’Œ32bitçš„å­—ç¬¦ï¼Œå°±æ˜¯å‰é¢è¯´çš„UTF-16çš„ä¸€ä¸ªå•å…ƒå’ŒUTF-32çš„ä¸€ä¸ªå•å…ƒã€‚
* C++11ä¸­çš„`u16string`ä¸`u32string`å°±æ˜¯å°±æ˜¯å°è£…äº†çš„`char16_t`å’Œ`char32_t`æ•°ç»„ã€‚

å†è¯´javaï¼ŒJavaä¸­çš„charå°±æ˜¯16bitçš„å­—ç¬¦ï¼Œå’ŒC11ä¸­çš„`char16_t`æ˜¯ä¸€æ ·çš„ã€‚Javaä¸­çš„Stringå°±æ˜¯UTF-16ã€‚

å¯¹äºC/C++ä¸­çš„å­—ç¬¦ä¸²ï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯æ²¡æ³•å½“åšå­—ç¬¦ä¸²ç”¨ï¼Œåªèƒ½å½“å­—èŠ‚æµç”¨ã€‚æ¯”å¦‚ä¸‹é¢çš„ä»£ç ï¼š

```c++
// C
char *ss = "hello ä¸–ç•Œ";
strlen(ss) = ?

// C++
string ss = "hello ä¸–ç•Œ";
ss.size() = ?
```

ä¸ç®¡ä»€ä¹ˆï¼Œç›´æ¥ç»™å‡ºä¸€ä¸ªæ•°å­—éƒ½æ˜¯é”™çš„ã€‚å–å†³äºçš„æºæ–‡ä»¶ç¼–ç ï¼š

* è¦æ˜¯UTF-8ï¼Œ6+2*3=12
* è¦æ˜¯UTF-16ï¼Œ8*2=16
* è¦æ˜¯UTF-32ï¼Œ8*4=32
* è¦æ˜¯GBKï¼Œ6+2*2=10

å…‰æ˜¯ä¸€ä¸ªç®—å­—ç¬¦æ•°å°±è¿™ä¹ˆè›‹ç–¼ï¼Œæ›´ä½•å†µå…¶å®ƒçš„å­—ç¬¦æ“ä½œã€‚æ¯”å¦‚æŠŠâ€œç¬¬ä¸€åâ€æ”¹æˆâ€œç¬¬äºŒåâ€ï¼Œä½ è¦æ”¹å¤šå°‘ä¸ªå­—èŠ‚ï¼Œä»ç¬¬å‡ ä¸ªå¼€å§‹è¯¥å‘¢ï¼Ÿ

å¯¹äºJavaå°±ç®€å•äº†ï¼Œä¸Šé¢çš„å­—ç¬¦æ“ä½œéƒ½æ¯”è¾ƒç®€å•ï¼Œä¸è¿‡é‡åˆ°éœ€è¦ç”¨`surrogate pairs`è¡¨ç¤ºçš„ï¼Œå°±æœ‰ç‚¹éº»çƒ¦äº†ã€‚
è™½ç„¶å¯¹äºå­—ç¬¦æ“ä½œé—®é¢˜ä¸å¤§ï¼Œä½†æ˜¯é‡åˆ°éœ€è¦å¤„ç†å…¶å®ƒç¼–ç çš„æƒ…å†µæ—¶ï¼Œå°±å˜å¾—å’ŒC/C++ä¸€æ ·äº†ï¼Œå› ä¸ºJavaä¸­çš„Charä¸Stringå°±åªæ˜¯UTF-16ã€‚
ä¸€èˆ¬éƒ½æ˜¯è¿™æ ·å¤„ç†ï¼š
* å°†å…¶å®ƒç¼–ç çš„æ•°æ®çœ‹åšå­—èŠ‚æµï¼Œç„¶åå°†è¯¥ç¼–ç å­—çš„èŠ‚æµè½¬æ¢æˆUTF-16è¡¨ç¤ºçš„å­—èŠ‚æµ
* å°†UTF-16è¡¨ç¤ºçš„å­—èŠ‚æµè½¬æ¢æˆStringï¼ˆå†…å®¹æ²¡å˜ï¼‰ï¼Œè¿›è¡Œå­—ç¬¦æ–‡æœ¬çš„å¤„ç†
* å¤„ç†å®Œäº†åå°†Stringè½¬æ¢æˆUTF-16è¡¨ç¤ºçš„å­—èŠ‚æµ
* æœ€åå°†UTF-16è¡¨ç¤ºçš„å­—èŠ‚æµè½¬æ¢æˆåŸæ¥ç¼–ç è¡¨ç¤ºçš„å­—èŠ‚æµ
å½“ç„¶ï¼ŒJavaæä¾›äº†`String.getBytes(Charset)`ä»¥åŠ`byte[].toString(Charset)`è¿™æ ·ç®€å•APIå°è£…äº†ä¸Šè¿°è¿‡ç¨‹ï¼Œä½¿ç”¨èµ·æ¥å¾ˆç®€å•ã€‚
è™½ç„¶å‡½æ•°ç­¾åæ˜¯`String`ä¸`byte[]`çš„è½¬æ¢ï¼Œä¸è¿‡æœ¬è´¨ä¸Šæ˜¯å­—èŠ‚æµçš„è½¬æ¢ã€‚ä¾‹å¦‚ä¸‹é¢å°†Stringè½¬æ¢æˆUTF-8ç¼–ç çš„å­—èŠ‚æµçš„ä»£ç ã€‚
ï¼ˆ[UTF_8.Encoder.encodeArrayLoop](http://grepcode.com/file/repository.grepcode.com/java/root/jdk/openjdk/6-b14/sun/nio/cs/UTF_8.java#UTF_8.Encoder.encodeArrayLoop)ï¼‰

```java
    private CoderResult encodeArrayLoop(CharBuffer src,
                                        ByteBuffer dst)
    {
        char[] sa = src.array();
        int sp = src.arrayOffset() + src.position();
        int sl = src.arrayOffset() + src.limit();

        byte[] da = dst.array();
        int dp = dst.arrayOffset() + dst.position();
        int dl = dst.arrayOffset() + dst.limit();
        int dlASCII = dp + Math.min(sl - sp, dl - dp);

        //ASCII only loop
        while (dp < dlASCII && sa[sp] < '\u0080')
            da[dp++] = (byte) sa[sp++];
        while (sp < sl) {
            int c = sa[sp];
            if (c < 0x80) {
                // Have at most seven bits
                if (dp >= dl)
                    return overflow(src, sp, dst, dp);
                da[dp++] = (byte)c;
            } else if (c < 0x800) {
                // 2 bytes, 11 bits
                if (dl - dp < 2)
                   return overflow(src, sp, dst, dp);
                da[dp++] = (byte)(0xc0 | ((c >> 06)));
                da[dp++] = (byte)(0x80 | (c & 0x3f));
            } else if (Surrogate.is(c)) {
                // Have a surrogate pair
                if (sgp == null)
                    sgp = new Surrogate.Parser();
                int uc = sgp.parse((char)c, sa, sp, sl);
                if (uc < 0) {
                    updatePositions(src, sp, dst, dp);
                    return sgp.error();
                }
                if (dl - dp < 4)
                    return overflow(src, sp, dst, dp);
                da[dp++] = (byte)(0xf0 | ((uc >> 18)));
                da[dp++] = (byte)(0x80 | ((uc >> 12) & 0x3f));
                da[dp++] = (byte)(0x80 | ((uc >> 06) & 0x3f));
                da[dp++] = (byte)(0x80 | (uc & 0x3f));
                sp++;  // 2 chars
            } else {
                // 3 bytes, 16 bits
                if (dl - dp < 3)
                    return overflow(src, sp, dst, dp);
                da[dp++] = (byte)(0xe0 | ((c >> 12)));
                da[dp++] = (byte)(0x80 | ((c >> 06) & 0x3f));
                da[dp++] = (byte)(0x80 | (c & 0x3f));
            }
            sp++;
        }
        updatePositions(src, sp, dst, dp);
        return CoderResult.UNDERFLOW;
    }
```

å†è¯´è¯´Pythonã€‚Python2é‡Œé¢å­—ç¬¦ç¼–ç ä¹Ÿæ˜¯å’Œå‰é¢ä¸€æ ·ï¼Œbytesã€strè¿˜æœ‰Unicodeçš„æ¦‚å¿µå‘äº†å¾ˆå¤šäººã€‚Python3å°±éå¸¸æ¸…æ™°äº†ã€‚
Python3é‡Œé¢å°±æ˜¯`str`ï¼šå­—ç¬¦ä¸²ï¼ˆ`Unicode code point sequence`ï¼‰ï¼Œ`bytes`ï¼šå­—èŠ‚ä¸²ï¼Œä¸¤è€…é€šè¿‡`encode`å’Œ`decode`æ¥ç›¸äº’è½¬æ¢ã€‚
è‡³äºå…¶å†…éƒ¨è¡¨ç¤ºï¼Œå°±ä¸æ˜¯Javaé‡Œé¢ç›´æ¥ç”¨UTF-16ï¼Œè€Œæ˜¯æ¯”è¾ƒå¤æ‚çš„å¤åˆç±»å‹ã€‚ä¸»è¦æ˜¯è€ƒè™‘å•å­—èŠ‚æˆ–è€…16bitä¸€ä¸ªå•å…ƒä¸æ–¹ä¾¿å¤„ç†non-BMPéƒ¨åˆ†ï¼Œè€Œ32bitåˆæµªè´¹ç©ºé—´ã€‚
è¯¦è§[PEP 393](https://www.python.org/dev/peps/pep-0393/)ã€‚æºä»£ç ï¼ˆ`Include/unicodeobje.h`ï¼‰ä¸­å®šä¹‰å¦‚ä¸‹ï¼š

```c
/* ASCII-only strings created through PyUnicode_New use the PyASCIIObject
   structure. state.ascii and state.compact are set, and the data
   immediately follow the structure. utf8_length and wstr_length can be found
   in the length field; the utf8 pointer is equal to the data pointer. */
typedef struct {
    /* There are 4 forms of Unicode strings:

       - compact ascii:

         * structure = PyASCIIObject
         * test: PyUnicode_IS_COMPACT_ASCII(op)
         * kind = PyUnicode_1BYTE_KIND
         * compact = 1
         * ascii = 1
         * ready = 1
         * (length is the length of the utf8 and wstr strings)
         * (data starts just after the structure)
         * (since ASCII is decoded from UTF-8, the utf8 string are the data)

       - compact:

         * structure = PyCompactUnicodeObject
         * test: PyUnicode_IS_COMPACT(op) && !PyUnicode_IS_ASCII(op)
         * kind = PyUnicode_1BYTE_KIND, PyUnicode_2BYTE_KIND or
           PyUnicode_4BYTE_KIND
         * compact = 1
         * ready = 1
         * ascii = 0
         * utf8 is not shared with data
         * utf8_length = 0 if utf8 is NULL
         * wstr is shared with data and wstr_length=length
           if kind=PyUnicode_2BYTE_KIND and sizeof(wchar_t)=2
           or if kind=PyUnicode_4BYTE_KIND and sizeof(wchar_t)=4
         * wstr_length = 0 if wstr is NULL
         * (data starts just after the structure)

       - legacy string, not ready:

         * structure = PyUnicodeObject
         * test: kind == PyUnicode_WCHAR_KIND
         * length = 0 (use wstr_length)
         * hash = -1
         * kind = PyUnicode_WCHAR_KIND
         * compact = 0
         * ascii = 0
         * ready = 0
         * interned = SSTATE_NOT_INTERNED
         * wstr is not NULL
         * data.any is NULL
         * utf8 is NULL
         * utf8_length = 0

       - legacy string, ready:

         * structure = PyUnicodeObject structure
         * test: !PyUnicode_IS_COMPACT(op) && kind != PyUnicode_WCHAR_KIND
         * kind = PyUnicode_1BYTE_KIND, PyUnicode_2BYTE_KIND or
           PyUnicode_4BYTE_KIND
         * compact = 0
         * ready = 1
         * data.any is not NULL
         * utf8 is shared and utf8_length = length with data.any if ascii = 1
         * utf8_length = 0 if utf8 is NULL
         * wstr is shared with data.any and wstr_length = length
           if kind=PyUnicode_2BYTE_KIND and sizeof(wchar_t)=2
           or if kind=PyUnicode_4BYTE_KIND and sizeof(wchar_4)=4
         * wstr_length = 0 if wstr is NULL

       Compact strings use only one memory block (structure + characters),
       whereas legacy strings use one block for the structure and one block
       for characters.

       Legacy strings are created by PyUnicode_FromUnicode() and
       PyUnicode_FromStringAndSize(NULL, size) functions. They become ready
       when PyUnicode_READY() is called.

       See also _PyUnicode_CheckConsistency().
    */
    PyObject_HEAD
    Py_ssize_t length;          /* Number of code points in the string */
    Py_hash_t hash;             /* Hash value; -1 if not set */
    struct {
        /*
           SSTATE_NOT_INTERNED (0)
           SSTATE_INTERNED_MORTAL (1)
           SSTATE_INTERNED_IMMORTAL (2)

           If interned != SSTATE_NOT_INTERNED, the two references from the
           dictionary to this object are *not* counted in ob_refcnt.
         */
        unsigned int interned:2;
        /* Character size:

           - PyUnicode_WCHAR_KIND (0):

             * character type = wchar_t (16 or 32 bits, depending on the
               platform)

           - PyUnicode_1BYTE_KIND (1):

             * character type = Py_UCS1 (8 bits, unsigned)
             * all characters are in the range U+0000-U+00FF (latin1)
             * if ascii is set, all characters are in the range U+0000-U+007F
               (ASCII), otherwise at least one character is in the range
               U+0080-U+00FF

           - PyUnicode_2BYTE_KIND (2):

             * character type = Py_UCS2 (16 bits, unsigned)
             * all characters are in the range U+0000-U+FFFF (BMP)
             * at least one character is in the range U+0100-U+FFFF

           - PyUnicode_4BYTE_KIND (4):

             * character type = Py_UCS4 (32 bits, unsigned)
             * all characters are in the range U+0000-U+10FFFF
             * at least one character is in the range U+10000-U+10FFFF
         */
        unsigned int kind:3;
        /* Compact is with respect to the allocation scheme. Compact unicode
           objects only require one memory block while non-compact objects use
           one block for the PyUnicodeObject struct and another for its data
           buffer. */
        unsigned int compact:1;
        /* The string only contains characters in the range U+0000-U+007F (ASCII)
           and the kind is PyUnicode_1BYTE_KIND. If ascii is set and compact is
           set, use the PyASCIIObject structure. */
        unsigned int ascii:1;
        /* The ready flag indicates whether the object layout is initialized
           completely. This means that this is either a compact object, or
           the data pointer is filled out. The bit is redundant, and helps
           to minimize the test in PyUnicode_IS_READY(). */
        unsigned int ready:1;
        /* Padding to ensure that PyUnicode_DATA() is always aligned to
           4 bytes (see issue #19537 on m68k). */
        unsigned int :24;
    } state;
    wchar_t *wstr;              /* wchar_t representation (null-terminated) */
} PyASCIIObject;

/* Non-ASCII strings allocated through PyUnicode_New use the
   PyCompactUnicodeObject structure. state.compact is set, and the data
   immediately follow the structure. */
typedef struct {
    PyASCIIObject _base;
    Py_ssize_t utf8_length;     /* Number of bytes in utf8, excluding the
                                 * terminating \0. */
    char *utf8;                 /* UTF-8 representation (null-terminated) */
    Py_ssize_t wstr_length;     /* Number of code points in wstr, possible
                                 * surrogates count as two code points. */
} PyCompactUnicodeObject;

/* Strings allocated through PyUnicode_FromUnicode(NULL, len) use the
   PyUnicodeObject structure. The actual string data is initially in the wstr
   block, and copied into the data block using _PyUnicode_Ready. */
typedef struct {
    PyCompactUnicodeObject _base;
    union {
        void *any;
        Py_UCS1 *latin1;
        Py_UCS2 *ucs2;
        Py_UCS4 *ucs4;
    } data;                     /* Canonical, smallest-form Unicode buffer */
} PyUnicodeObject;
```

---

**to be continuedâ€¦**


